<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Ondas SSC7 - Mercado Livre</title>
    
    <!-- Design e Estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #EBEBEB; /* Cinza oficial ML */
            -webkit-tap-highlight-color: transparent;
        }
        .animate-progress { transition: width 1s linear; }
        .bg-ml-yellow { background-color: #FFE600; }
        .bg-ml-blue { background-color: #3483FA; }
        .text-ml-blue { color: #3483FA; }
        .ml-card {
            background-color: #FFFFFF;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1);
        }
        .btn-shadow { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Bibliotecas Essenciais -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURAÇÃO FIREBASE
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "", 
                authDomain: "",
                projectId: "",
                storageBucket: "",
                messagingSenderId: "",
                appId: ""
            };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Disponibilizar para o script Babel
        window.FirebaseAPI = { 
            auth, db, appId, serverTimestamp, doc, updateDoc, setDoc, onSnapshot, 
            signInAnonymously, signInWithCustomToken, onAuthStateChanged 
        };
    </script>

    <!-- Lógica da Aplicação -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;
        const { auth, db, appId, serverTimestamp, doc, updateDoc, setDoc, onSnapshot, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = window.FirebaseAPI;

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('timer');
            const [isMuted, setIsMuted] = useState(false);
            const [systemTime, setSystemTime] = useState('');
            const [availableVoices, setAvailableVoices] = useState([]);
            const [selectedVoiceName, setSelectedVoiceName] = useState('');
            const [connectionStatus, setConnectionStatus] = useState('A autenticar...');

            const INITIAL_STATE = {
                activeWaveIndex: 0,
                isRunning: false,
                serverStartTime: null,
                secondsRemainingOnPause: 30 * 60,
                alarmTriggerMinutes: 1,
                alarmRepeatSeconds: 45,
                isHornEnabled: true,
                isAutoStartEnabled: false,
                scheduledStartTime: "12:30",
                waves: [
                    { id: 1, name: 'Onda 1', duration: 30 * 60, startTime: '12:30' },
                    { id: 2, name: 'Onda 2', duration: 20 * 60, startTime: '13:00' },
                    { id: 3, name: 'Onda 3', duration: 20 * 60, startTime: '13:20' },
                    { id: 4, name: 'Onda 4', duration: 20 * 60, startTime: '13:40' },
                    { id: 5, name: 'Onda 5', duration: 20 * 60, startTime: '14:00' },
                    { id: 6, name: 'Onda 6', duration: 20 * 60, startTime: '14:20' },
                    { id: 7, name: 'Onda 7', duration: 5 * 60, startTime: '14:40' }
                ]
            };

            const [syncData, setSyncData] = useState(INITIAL_STATE);
            const [timeLeft, setTimeLeft] = useState(INITIAL_STATE.secondsRemainingOnPause);
            const lastAnnouncedTrigger = useRef(null);
            const lastAutoStartTriggered = useRef("");

            // 1. Autenticação (Regra 3 - Auth antes de Queries)
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        setConnectionStatus('Erro de Autenticação');
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (u) setConnectionStatus('Ligado à Nuvem');
                });
                return () => unsubscribe();
            }, []);

            // Carregar Vozes do Sistema
            useEffect(() => {
                const loadVoices = () => {
                    const v = window.speechSynthesis.getVoices().filter(x => x.lang.startsWith('pt'));
                    setAvailableVoices(v);
                    if (v.length > 0 && !selectedVoiceName) setSelectedVoiceName(v[0].name);
                };
                loadVoices();
                window.speechSynthesis.onvoiceschanged = loadVoices;
            }, []);

            // 2. Sincronização Cloud (Regra 1 - Caminho Estrito)
            useEffect(() => {
                if (!user) return;
                
                // Caminho rigoroso: /artifacts/{appId}/public/data/{collectionName}/{docId}
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'waves_sync', 'global');
                
                const unsubscribe = onSnapshot(docRef, (snap) => {
                    if (snap.exists()) {
                        setSyncData(snap.data());
                    } else {
                        // Criar documento inicial com permissões
                        setDoc(docRef, INITIAL_STATE);
                    }
                }, (err) => {
                    setConnectionStatus('Erro de Permissão');
                });

                return () => unsubscribe();
            }, [user]);

            // 3. Relógio e Início Automático
            useEffect(() => {
                const clockTimer = setInterval(() => {
                    const now = new Date();
                    const nowStr = now.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });
                    setSystemTime(nowStr);

                    if (syncData.isAutoStartEnabled && !syncData.isRunning && syncData.activeWaveIndex === 0 && timeLeft === syncData.waves[0].duration) {
                        if (nowStr === syncData.scheduledStartTime && lastAutoStartTriggered.current !== nowStr) {
                            lastAutoStartTriggered.current = nowStr;
                            handleToggleTimer();
                        }
                    }
                }, 1000);
                return () => clearInterval(clockTimer);
            }, [syncData, timeLeft, user]);

            // 4. Temporizador Sincronizado
            useEffect(() => {
                const timerInterval = setInterval(() => {
                    if (syncData.isRunning && syncData.serverStartTime) {
                        const now = Date.now();
                        const startMillis = syncData.serverStartTime?.toMillis ? syncData.serverStartTime.toMillis() : syncData.serverStartTime;
                        const elapsedSeconds = Math.floor((now - startMillis) / 1000);
                        const remaining = Math.max(0, syncData.secondsRemainingOnPause - elapsedSeconds);
                        
                        setTimeLeft(remaining);
                        
                        if (remaining === 0) {
                            handleAutoWaveComplete();
                        }
                    } else {
                        setTimeLeft(syncData.secondsRemainingOnPause);
                    }
                }, 1000);
                return () => clearInterval(timerInterval);
            }, [syncData]);

            // 5. Alertas Sonoros
            useEffect(() => {
                if (!syncData.isRunning || timeLeft <= 0) return;
                const triggerSeconds = syncData.alarmTriggerMinutes * 60;
                
                if (timeLeft <= triggerSeconds) {
                    const elapsedFromTrigger = triggerSeconds - timeLeft;
                    if (elapsedFromTrigger % syncData.alarmRepeatSeconds === 0 && lastAnnouncedTrigger.current !== timeLeft) {
                        lastAnnouncedTrigger.current = timeLeft;
                        if (syncData.isHornEnabled) playHorn();
                        setTimeout(() => speak(`ATENÇÃO, ${syncData.waves[syncData.activeWaveIndex].name} prestes a acabar.`), 800);
                    }
                }
            }, [timeLeft, syncData.isRunning]);

            // Inicializar ícones
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            const playHorn = () => {
                if (isMuted || !syncData.isHornEnabled) return;
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc1 = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc1.type = 'square';
                    osc1.frequency.setValueAtTime(340, ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0.1, ctx.currentTime + 0.1);
                    gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.8);
                    osc1.connect(gain); gain.connect(ctx.destination);
                    osc1.start(); osc1.stop(ctx.currentTime + 0.8);
                    setTimeout(() => ctx.close(), 1000);
                } catch(e) {}
            };

            const speak = (text) => {
                if (isMuted || !text) return;
                window.speechSynthesis.cancel();
                const utter = new SpeechSynthesisUtterance(text);
                const voice = availableVoices.find(v => v.name === selectedVoiceName);
                if (voice) utter.voice = voice;
                else utter.lang = 'pt-PT';
                window.speechSynthesis.speak(utter);
            };

            const updateCloud = async (updates) => {
                if (!user) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'waves_sync', 'global');
                try { await updateDoc(docRef, updates); } catch(e) {}
            };

            const handleToggleTimer = () => {
                if (syncData.isRunning) {
                    updateCloud({ isRunning: false, secondsRemainingOnPause: timeLeft });
                } else {
                    if (timeLeft === syncData.waves[syncData.activeWaveIndex].duration) {
                        speak(`Iniciando a ${syncData.waves[syncData.activeWaveIndex].name}`);
                    }
                    updateCloud({ isRunning: true, serverStartTime: Date.now() });
                }
            };

            const handleAutoWaveComplete = () => {
                if (syncData.isRunning) {
                    updateCloud({ isRunning: false, secondsRemainingOnPause: 0 });
                    speak(`Onda finalizada.`);
                }
            };

            const handleReset = () => {
                updateCloud({
                    isRunning: false,
                    activeWaveIndex: 0,
                    secondsRemainingOnPause: syncData.waves[0].duration,
                    serverStartTime: null
                });
            };

            const handleNextWave = () => {
                const nextIdx = syncData.activeWaveIndex + 1;
                if (nextIdx < syncData.waves.length) {
                    updateCloud({
                        activeWaveIndex: nextIdx,
                        secondsRemainingOnPause: syncData.waves[nextIdx].duration,
                        isRunning: false,
                        serverStartTime: null
                    });
                }
            };

            const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
            const currentWave = syncData.waves[syncData.activeWaveIndex];
            const progress = ((currentWave.duration - timeLeft) / currentWave.duration) * 100;

            if (view === 'setup') {
                return (
                    <div className="p-6 md:p-12 max-w-2xl mx-auto min-h-screen">
                        <button onClick={() => setView('timer')} className="flex items-center gap-2 mb-8 text-slate-500 hover:text-slate-900 font-bold uppercase text-xs">
                            <i data-lucide="arrow-left" className="w-4 h-4"></i> Voltar ao Painel
                        </button>
                        <h1 className="text-3xl font-black mb-8 text-slate-900 uppercase">Configuração Cloud</h1>
                        <div className="ml-card border border-slate-200 p-8 rounded-xl shadow-sm space-y-8">
                            <div className="bg-slate-50 p-6 rounded-lg border border-[#3483FA]/20 space-y-4">
                                <h3 className="text-xs font-black text-[#3483FA] flex items-center gap-2 uppercase tracking-widest">
                                    <i data-lucide="calendar" className="w-4 h-4"></i> Início Turno
                                </h3>
                                <div className="flex gap-4">
                                    <input type="time" value={syncData.scheduledStartTime} onChange={(e) => updateCloud({ scheduledStartTime: e.target.value })} className="bg-white p-3 rounded-lg border border-slate-300 focus:border-[#3483FA] outline-none font-bold text-xl w-full" />
                                    <button onClick={() => updateCloud({ isAutoStartEnabled: !syncData.isAutoStartEnabled })} className={`px-6 rounded-lg font-bold border transition-all ${syncData.isAutoStartEnabled ? 'bg-[#3483FA] text-white border-[#3483FA]' : 'bg-white text-slate-400 border-slate-200'}`}>
                                        Auto-Start: {syncData.isAutoStartEnabled ? 'ON' : 'OFF'}
                                    </button>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-2">
                                    <label className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Alerta (min):</label>
                                    <input type="number" step="0.5" value={syncData.alarmTriggerMinutes} onChange={e => updateCloud({ alarmTriggerMinutes: parseFloat(e.target.value) })} className="w-full p-3 rounded-lg border border-slate-300 font-bold" />
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Repete (seg):</label>
                                    <input type="number" value={syncData.alarmRepeatSeconds} onChange={e => updateCloud({ alarmRepeatSeconds: parseInt(e.target.value) })} className="w-full p-3 rounded-lg border border-slate-300 font-bold" />
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="p-4 md:p-12 max-w-5xl mx-auto min-h-screen" onClick={() => speak('')}>
                    <header className="flex justify-between items-center mb-6 bg-[#FFE600] p-5 rounded-xl border-b-2 border-yellow-400 shadow-sm">
                        <div className="flex items-center gap-4 text-slate-900">
                            <div className="bg-white p-2 rounded-lg shadow-sm"><i data-lucide="package" className="w-7 h-7"></i></div>
                            <div>
                                <h1 className="text-2xl font-black uppercase tracking-tighter leading-none">Waves SSC7</h1>
                                <p className="text-slate-800 text-[10px] font-black uppercase tracking-widest mt-1">Lages, SC • {connectionStatus}</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setView('setup')} className="p-3 bg-white/30 rounded-lg hover:bg-white/50 text-slate-900 transition-all"><i data-lucide="settings" className="w-6 h-6"></i></button>
                            <button onClick={() => setIsMuted(!isMuted)} className={`p-3 rounded-lg shadow-sm transition-all ${isMuted ? 'bg-red-500 text-white border-red-600' : 'bg-white text-slate-900 border-slate-200'}`}>
                                <i data-lucide={isMuted ? "volume-x" : "volume-2"} className="w-6 h-6"></i>
                            </button>
                        </div>
                    </header>

                    <div className="ml-card border border-slate-200 rounded-2xl p-10 md:p-16 text-center relative overflow-hidden mb-8">
                        <div className="relative z-10">
                            <div className="flex justify-center mb-8">
                                <span className={`px-6 py-2 rounded-full font-black uppercase tracking-widest text-xs border-2 ${timeLeft <= syncData.alarmTriggerMinutes * 60 ? 'bg-red-500 text-white border-red-400 animate-pulse shadow-lg' : 'bg-slate-100 text-slate-600 border-slate-200'}`}>
                                    {currentWave.name} em curso
                                </span>
                            </div>
                            
                            <div className={`text-[11rem] md:text-[14rem] font-black my-4 font-mono tracking-tighter leading-none transition-all ${timeLeft <= syncData.alarmTriggerMinutes * 60 ? 'text-red-500 scale-105' : 'text-slate-900'}`}>
                                {formatTime(timeLeft)}
                            </div>

                            <div className="max-w-lg mx-auto mb-14">
                                <div className="w-full bg-slate-100 h-7 rounded-full overflow-hidden border-2 border-slate-200 p-1 shadow-inner">
                                    <div className={`h-full rounded-full transition-all duration-1000 ${timeLeft <= syncData.alarmTriggerMinutes * 60 ? 'bg-red-500' : 'bg-[#FFE600]'}`} style={{ width: `${progress}%` }} />
                                </div>
                            </div>

                            <div className="flex flex-wrap justify-center gap-5">
                                <button onClick={handleReset} className="bg-slate-100 text-slate-700 px-8 py-5 rounded-2xl hover:bg-slate-200 transition-all font-black uppercase text-sm border-2 border-slate-200 flex items-center gap-3">
                                    <i data-lucide="rotate-ccw" className="w-5 h-5"></i> Reset
                                </button>
                                <button onClick={handleToggleTimer} className={`px-16 py-6 rounded-2xl font-black uppercase text-lg flex items-center gap-3 shadow-xl transition-all active:scale-95 ${syncData.isRunning ? 'bg-[#3483FA] text-white' : 'bg-[#FFE600] text-slate-950'}`}>
                                    {syncData.isRunning ? <><i data-lucide="pause" className="w-8 h-8 fill-current"></i> Pausar</> : <><i data-lucide="play" className="w-8 h-8 fill-current"></i> Iniciar</>}
                                </button>
                                {timeLeft === 0 && syncData.activeWaveIndex < syncData.waves.length - 1 && (
                                    <button onClick={handleNextWave} className="bg-[#3483FA] px-10 py-6 rounded-2xl font-black text-white shadow-xl animate-bounce uppercase">Próxima Onda</button>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
                        {syncData.waves.map((w, i) => (
                            <div key={w.id} className={`p-6 rounded-2xl border-2 transition-all ${i === syncData.activeWaveIndex ? 'border-[#FFE600] bg-white shadow-md scale-105' : i < syncData.activeWaveIndex ? 'border-transparent bg-slate-200/50 opacity-40 grayscale' : 'border-white bg-white opacity-80'}`}>
                                <div className="text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">{i < syncData.activeWaveIndex ? 'OK' : i === syncData.activeWaveIndex ? 'Agora' : 'Fila'}</div>
                                <div className="text-sm font-black text-slate-800 leading-tight">{w.name}</div>
                                <div className="text-xl font-mono font-black text-[#3483FA]/70 leading-none mt-1">{w.startTime}</div>
                            </div>
                        ))}
                    </div>

                    <footer className="mt-12 flex justify-center gap-4 opacity-50">
                        <div className="bg-white border border-slate-200 px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-sm flex items-center gap-2">
                            <i data-lucide="clock" className="w-4 h-4"></i> {systemTime}
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
